# MusicGen Batch System - Setup Guide

This guide walks you through setting up the development environment, AWS infrastructure and authentication for the MusicGen batch generation system.

## Quick Start

1. **Run the setup script:**
   ```bash
   python setup_aws.py
   ```
   This will install uv, set up the project, install dependencies, configure AWS CLI, and create your .env file.

2. **Check AWS readiness:**
   ```bash
   uv run python check_aws_readiness.py
   ```

## Prerequisites

- Python 3.8+ (uv will manage the virtual environment)
- Internet connection for downloading dependencies and AWS API calls

## Detailed Setup Process

### Step 1: Initial Setup

The `setup_aws.py` script will:
- ✅ Install uv package manager if needed (Linux/macOS)
- ✅ Set up Python virtual environment and install dependencies
- ✅ Install AWS CLI if needed (Linux/macOS)
- ✅ Guide you through AWS credential setup
- ✅ Create and configure your `.env` file
- ✅ Test authentication

**Run:**
```bash
python setup_aws.py
```

### Step 2: AWS Account Preparation

The `check_aws_readiness.py` script will:
- ✅ Verify AWS credentials and permissions
- ✅ Check EC2 service limits for g4dn.xlarge instances
- ✅ Create S3 bucket for output storage
- ✅ Create IAM role and policies for EC2 instances
- ✅ Verify EC2 key pair exists
- ✅ Provide billing alert setup instructions

**Run:**
```bash
uv run python check_aws_readiness.py
```

### Step 3: Manual Tasks (After Scripts)

1. **Create EC2 Key Pair** (if you don't have one):
   - Go to AWS Console → EC2 → Key Pairs
   - Click "Create key pair"
   - Choose a name and download the `.pem` file
   - Update `KEY_PAIR_NAME` in your `.env` file

2. **Set up Billing Alerts** (recommended):
   - Go to AWS Console → Billing Dashboard
   - Click "Budgets" → "Create budget"
   - Set a reasonable monthly limit (e.g., $50)
   - Configure email notifications

## Configuration Files

### `.env` File
Contains your AWS configuration (auto-generated from `.env.template`):
```bash
AWS_ACCOUNT_ID=123456789012
AWS_REGION=us-east-1
S3_BUCKET_NAME=musicgen-batch-output-unique-suffix
KEY_PAIR_NAME=your-keypair-name
MAX_SPOT_PRICE=0.40
IAM_ROLE_NAME=musicgen-worker-role
INSTANCE_TYPE=g4dn.xlarge
```

**Important:** Never commit `.env` to source control - it's already in `.gitignore`

## Authentication Methods

The setup script supports multiple AWS authentication methods:

### Method 1: AWS CLI Configure (Recommended)
- Interactive setup with `aws configure`
- Stores credentials in `~/.aws/credentials`
- Best for development

### Method 2: Environment Variables
- Set `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`
- Good for CI/CD or temporary setups

### Method 3: AWS SSO
- For organizations using AWS SSO
- Requires SSO start URL and region

### Method 4: IAM Roles (Production)
- For EC2 instances with attached roles
- Not applicable for local development

## Prerequisites

### System Requirements
- Python 3.8+ (uv will manage virtual environments and dependencies)
- Internet connection for AWS API calls and dependency downloads
- Sufficient disk space for uv, AWS CLI, and dependencies

### AWS Account Requirements
- Valid AWS account with billing enabled
- Permissions for EC2, S3, and IAM operations
- Sufficient service limits for g4dn.xlarge instances

## Troubleshooting

### Common Issues

**"AWS CLI not found"**
- Run `setup_aws.py` to install AWS CLI automatically
- Or install manually from [AWS documentation](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)

**"NoCredentialsError"**
- Run `setup_aws.py` and choose authentication method
- Verify credentials with `aws sts get-caller-identity`

**"Access Denied" errors**
- Your AWS user needs permissions for EC2, S3, and IAM
- Attach `PowerUserAccess` policy or create custom policy

**"Bucket name already taken"**
- S3 bucket names must be globally unique
- The script will prompt for a new name if needed

**"Key pair not found"**
- Create EC2 key pair in AWS Console
- Update `KEY_PAIR_NAME` in `.env` file

### Getting Help

**Check logs and error messages:**
- Both scripts provide detailed error messages
- Use `-v` flag for verbose output (if implemented)

**Verify AWS setup:**
```bash
aws sts get-caller-identity
aws ec2 describe-regions
```

**Check configuration:**
```bash
cat .env
```

**Check uv project status:**
```bash
uv tree  # Show dependency tree
uv run python --version  # Check Python version in virtual env
```

## Cost Management

### Expected Costs
- **g4dn.xlarge spot instances**: ~$0.10-0.40/hour
- **S3 storage**: ~$0.023/GB/month
- **Data transfer**: Minimal for this use case

### Cost Controls
- Maximum spot price configured in `.env`
- Billing alerts (set up manually)
- Instances must be manually terminated

### Cost Monitoring
- Set up billing alerts as recommended
- Monitor AWS Cost Explorer
- Review cost reports generated by the system

## Next Steps

After completing setup:
1. **Phase 2**: Create custom AMI with MusicGen dependencies
2. **Phase 3**: Implement launcher script
3. **Phase 4**: Create worker script
4. **Phase 5**: End-to-end testing

See `TASKS.md` for detailed implementation tasks.

## Security Notes

- `.env` file contains sensitive credentials - never commit to source control
- IAM roles use least-privilege permissions
- S3 buckets have public access blocked by default
- EC2 instances should be terminated when not in use

## File Structure

```
cloud-music/
├── setup_aws.py              # uv and AWS CLI setup script
├── check_aws_readiness.py    # Account validation and resource creation
├── pyproject.toml            # Project configuration and dependencies
├── .env.template             # Configuration template
├── .env                      # Your configuration (auto-generated)
├── .gitignore                # Excludes .env and keys/ from source control
├── keys/                     # SSH private keys directory
└── README_SETUP.md           # This file
```

## Development Workflow

Once set up, use these commands for development:

```bash
# Run scripts
uv run python setup_aws.py
uv run python check_aws_readiness.py

# Add new dependencies
uv add boto3  # Add runtime dependency
uv add --dev pytest  # Add development dependency

# Update dependencies
uv sync  # Sync with pyproject.toml
uv lock  # Update lock file

# Check project status
uv tree  # Show dependency tree
uv run python --version  # Python version in virtual env
```